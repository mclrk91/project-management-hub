<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .mobile-menu-open { transform: translateX(0); }
        .mobile-menu-closed { transform: translateX(-100%); }
        
        /* Desktop sidebar should always be visible */
        @media (min-width: 1024px) {
            .lg\:mobile-menu-open { transform: translateX(0) !important; }
        }
        
        /* Beautiful gradients */
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .gradient-warning { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .gradient-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        
        /* Enhanced shadows */
        .shadow-beautiful { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* Smooth animations */
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-bounce-subtle { animation: bounceSubtle 0.6s ease-in-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceSubtle {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-3px); }
            60% { transform: translateY(-2px); }
        }
        
        /* Beautiful hover effects */
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        
        /* Glass morphism effect */
        .glass { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.18); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Enhanced focus states */
        .focus-beautiful:focus { outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); border-color: #6366f1; }
        
        /* Task card clickable styling */
        .task-card-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .task-card-clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <!-- Mobile menu overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-beautiful sidebar-transition mobile-menu-closed lg:mobile-menu-open">
        <div class="gradient-bg flex items-center justify-between h-16 px-6">
            <h1 class="text-xl font-bold text-white animate-bounce-subtle">‚ú® Project Hub</h1>
            <button id="close-sidebar" class="lg:hidden p-2 rounded-md hover:bg-white hover:bg-opacity-20 text-white transition-all duration-200">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <nav class="mt-6 px-3">
            <div class="space-y-2">
                <a href="#" onclick="showSection('dashboard')" class="nav-link flex items-center px-4 py-3 text-sm font-medium rounded-xl text-white gradient-bg shadow-card hover-lift">
                    <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                    Overview
                </a>
                <a href="#" onclick="showSection('kanban')" class="nav-link flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Kanban Board
                </a>
                <a href="#" onclick="showSection('resources')" class="nav-link flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200">
                    <i data-lucide="folder" class="w-5 h-5 mr-3"></i>
                    Resources
                </a>
                <a href="#" onclick="showSection('vendors')" class="nav-link flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Vendors
                </a>
                <a href="#" onclick="showSection('ai-assistant')" class="nav-link flex items-center px-4 py-3 text-sm font-medium rounded-xl text-gray-700 hover:bg-gray-100 transition-all duration-200">
                    <i data-lucide="bot" class="w-5 h-5 mr-3"></i>
                    AI Assistant
                </a>
            </div>
            
            <div class="mt-8">
                <h3 class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">üöÄ Projects</h3>
                <div class="mt-2 space-y-1" id="project-list">
                    <!-- Project list will be loaded here -->
                </div>
            </div>
        </nav>
    </div>

    <!-- Main content -->
    <div class="lg:pl-64">
        <!-- Top navigation -->
        <div class="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white bg-opacity-80 backdrop-blur-sm px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
            <button id="open-sidebar" type="button" class="-m-2.5 p-2.5 text-gray-700 lg:hidden">
                <span class="sr-only">Open sidebar</span>
                <i data-lucide="menu" class="h-6 w-6"></i>
            </button>

            <div class="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
                <form class="relative flex flex-1" action="#" method="GET">
                    <label for="search-input" class="sr-only">Search</label>
                    <i data-lucide="search" class="pointer-events-none absolute inset-y-0 left-0 h-full w-5 text-gray-400 ml-3 mt-3"></i>
                    <input id="search-input" class="block h-full w-full border-0 py-0 pl-11 pr-0 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm bg-transparent focus-beautiful" placeholder="Search projects and tasks..." type="search" name="search">
                </form>
            </div>
        </div>

        <main class="py-10">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section px-4 sm:px-6 lg:px-8 animate-fade-in">
                <!-- Date Header -->
                <div class="mb-8 text-center">
                    <div class="text-4xl font-bold text-gray-900 mb-2" id="current-day-header"></div>
                    <div class="text-xl text-gray-600" id="current-month-date"></div>
                </div>

                <div class="sm:flex sm:items-center sm:justify-between mb-8">
                    <div class="animate-slide-up">
                        <h1 class="text-4xl font-bold leading-7 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent sm:truncate sm:text-5xl sm:tracking-tight">Dashboard</h1>
                    </div>
                    <div class="mt-6 sm:ml-16 sm:mt-0 sm:flex-none animate-slide-up">
                        <button onclick="showNewProjectForm()" class="group relative overflow-hidden rounded-2xl gradient-success px-6 py-3 text-center text-sm font-semibold text-white shadow-beautiful hover-lift transition-all duration-300">
                            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                            <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                            New Project
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                    <!-- Urgent Tasks -->
                    <div class="group bg-white bg-opacity-80 backdrop-blur-sm overflow-hidden shadow-beautiful rounded-2xl hover-lift transition-all duration-300 border border-white border-opacity-50">
                        <div class="p-8">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 p-3 rounded-2xl bg-gradient-to-r from-red-400 to-pink-500 shadow-card">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="ml-6 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-semibold text-gray-500 uppercase tracking-wider">‚ö° Urgent Tasks</dt>
                                        <dd class="text-lg font-medium text-gray-900">(48H)</dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Tasks due within the next 48 hours</h3>
                                <div id="urgent-tasks" class="space-y-2">
                                    <!-- Urgent tasks will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Projects -->
                    <div class="group bg-white bg-opacity-80 backdrop-blur-sm overflow-hidden shadow-beautiful rounded-2xl hover-lift transition-all duration-300 border border-white border-opacity-50">
                        <div class="p-8">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 p-3 rounded-2xl bg-gradient-to-r from-blue-400 to-indigo-500 shadow-card">
                                    <i data-lucide="folder" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="ml-6 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-semibold text-gray-500 uppercase tracking-wider">üìÅ Recent Projects</dt>
                                        <dd class="text-lg font-medium text-gray-900">Your most recently updated projects</dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="mt-6" id="recent-projects">
                                <!-- Recent projects will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Reminders -->
                    <div class="group bg-white bg-opacity-80 backdrop-blur-sm overflow-hidden shadow-beautiful rounded-2xl hover-lift transition-all duration-300 border border-white border-opacity-50">
                        <div class="p-8">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 p-3 rounded-2xl bg-gradient-to-r from-green-400 to-emerald-500 shadow-card">
                                    <i data-lucide="bell" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="ml-6 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-semibold text-gray-500 uppercase tracking-wider">üîî Reminders</dt>
                                        <dd class="text-lg font-medium text-gray-900">Quick notes & reminders</dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="mt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Personal Reminders</h3>
                                    <button onclick="addReminder()" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors duration-200">
                                        <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                        Add
                                    </button>
                                </div>
                                <div id="reminders-list" class="space-y-2 max-h-64 overflow-y-auto">
                                    <!-- Reminders will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kanban Section -->
            <div id="kanban-section" class="section hidden px-4 sm:px-6 lg:px-8 animate-fade-in">
                <div class="sm:flex sm:items-center sm:justify-between mb-8">
                    <div class="animate-slide-up">
                        <h1 class="text-4xl font-bold leading-7 bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent sm:truncate sm:text-5xl sm:tracking-tight">Kanban Board</h1>
                    </div>
                    <div class="mt-6 sm:mt-0 animate-slide-up">
                        <button onclick="showNewTaskForm()" class="group relative overflow-hidden rounded-2xl gradient-success px-6 py-3 text-center text-sm font-semibold text-white shadow-beautiful hover-lift transition-all duration-300">
                            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                            <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                            New Task
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="group bg-white bg-opacity-60 backdrop-blur-sm rounded-2xl p-6 shadow-beautiful border border-white border-opacity-50 hover-lift transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-gray-400 to-gray-500 mr-3"></div>
                            <h3 class="font-bold text-gray-800 text-lg">üìù To Do</h3>
                        </div>
                        <div id="todo-column" class="space-y-4 min-h-[200px]">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                    <div class="group bg-white bg-opacity-60 backdrop-blur-sm rounded-2xl p-6 shadow-beautiful border border-white border-opacity-50 hover-lift transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-blue-400 to-blue-500 mr-3"></div>
                            <h3 class="font-bold text-blue-800 text-lg">üöÄ In Progress</h3>
                        </div>
                        <div id="in-progress-column" class="space-y-4 min-h-[200px]">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                    <div class="group bg-white bg-opacity-60 backdrop-blur-sm rounded-2xl p-6 shadow-beautiful border border-white border-opacity-50 hover-lift transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 mr-3"></div>
                            <h3 class="font-bold text-orange-800 text-lg">üëÄ Review</h3>
                        </div>
                        <div id="review-column" class="space-y-4 min-h-[200px]">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                    <div class="group bg-white bg-opacity-60 backdrop-blur-sm rounded-2xl p-6 shadow-beautiful border border-white border-opacity-50 hover-lift transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 mr-3"></div>
                            <h3 class="font-bold text-green-800 text-lg">‚úÖ Completed</h3>
                        </div>
                        <div id="completed-column" class="space-y-4 min-h-[200px]">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resources Section -->
            <div id="resources-section" class="section hidden px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-yellow-600 bg-clip-text text-transparent">Resources</h1>
                    <button onclick="showNewResourceForm()" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-orange-500 to-yellow-600 hover:from-orange-600 hover:to-yellow-700 shadow-beautiful hover-lift transition-all duration-200">
                        <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                        New Resource
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="resources-list">
                    <!-- Resources will be loaded here -->
                </div>
            </div>

            <!-- Vendors Section -->
            <div id="vendors-section" class="section hidden px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">Vendors</h1>
                    <button onclick="showNewVendorForm()" class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 shadow-beautiful hover-lift transition-all duration-200">
                        <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                        New Vendor
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="vendors-list">
                    <!-- Vendors will be loaded here -->
                </div>
            </div>
            
            <!-- AI Assistant Section -->
            <div id="ai-assistant-section" class="section hidden px-4 sm:px-6 lg:px-8">
                <div class="sm:flex sm:items-center sm:justify-between mb-8">
                    <div class="animate-slide-up">
                        <h1 class="text-4xl font-bold leading-7 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent sm:truncate sm:text-5xl sm:tracking-tight">AI Assistant</h1>
                    </div>
                    <div class="mt-6 sm:ml-16 sm:mt-0 sm:flex-none animate-slide-up">
                        <button onclick="clearAIChat()" class="group relative overflow-hidden rounded-2xl bg-gray-600 px-6 py-3 text-center text-sm font-semibold text-white shadow-beautiful hover-lift transition-all duration-300">
                            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
                            <i data-lucide="trash-2" class="w-5 h-5 inline mr-2"></i>
                            Clear Chat
                        </button>
                    </div>
                </div>

                <!-- API Key Setup -->
                <div id="api-key-setup" class="mb-8 bg-white bg-opacity-80 backdrop-blur-sm rounded-2xl p-6 shadow-beautiful border border-white border-opacity-50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">OpenAI API Key Setup</h3>
                            <p class="text-sm text-gray-600">Your API key is stored locally and never shared. Get one at <a href="https://platform.openai.com" target="_blank" class="text-indigo-600 hover:text-indigo-500">platform.openai.com</a></p>
                        </div>
                        <button onclick="resetApiKey()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                            Reset Key
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key..." 
                               class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <button onclick="saveApiKey()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                            Save Key
                        </button>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="bg-white bg-opacity-80 backdrop-blur-sm rounded-2xl shadow-beautiful border border-white border-opacity-50 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">AI Assistant</h3>
                                <p class="text-sm text-gray-600">Hi! I'm your AI assistant. I can help you with questions about your projects, tasks, and vendors.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    
                    <div class="p-6 border-t border-gray-200">
                        <div class="flex space-x-3">
                            <input type="text" id="chat-input" placeholder="Ask me anything about your projects..." 
                                   class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                   onkeypress="if(event.key==='Enter') sendAIMessage()">
                            <button onclick="sendAIMessage()" id="send-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Results Section -->
            <div id="search-results-section" class="section hidden px-4 sm:px-6 lg:px-8">
                <div class="mb-8">
                    <button onclick="showSection('dashboard')" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium mb-4 flex items-center">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>
                        Back to Dashboard
                    </button>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Search Results</h1>
                </div>
                <div id="search-results-content">
                    <!-- Search results will be loaded here -->
                </div>
            </div>

            <!-- Task Detail Section -->
            <div id="task-detail-section" class="section hidden px-4 sm:px-6 lg:px-8">
                <!-- Task detail content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Modals and Forms -->
    <!-- New Project Modal -->
    <div id="new-project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Project</h3>
                <form id="new-project-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Title</label>
                        <input type="text" id="new-project-title" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="new-project-description" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideNewProjectForm()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Create Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Task Modal -->
    <div id="new-task-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Task</h3>
                <form id="new-task-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Task Title</label>
                        <input type="text" id="new-task-title" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="new-task-description" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select id="new-task-project" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <!-- Projects will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select id="new-task-priority" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="date" id="new-task-due-date" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideNewTaskForm()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Resource Modal -->
    <div id="new-resource-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Resource</h3>
                <form id="new-resource-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Resource Name</label>
                        <input type="text" id="new-resource-name" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                        <input type="url" id="new-resource-url" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="new-resource-description" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideNewResourceForm()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-md hover:bg-orange-700">Add Resource</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Vendor Modal -->
    <div id="new-vendor-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Vendor</h3>
                <form id="new-vendor-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vendor Name</label>
                        <input type="text" id="new-vendor-name" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
                        <input type="text" id="new-vendor-contact" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="new-vendor-email" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="new-vendor-phone" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Services</label>
                        <textarea id="new-vendor-services" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideNewVendorForm()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add Vendor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables - properly declared at the top level
        let currentSection = 'dashboard';
        let openaiApiKey = '';
        
        // Data with localStorage persistence
        let projects = JSON.parse(localStorage.getItem('projects')) || [
            { id: 1, title: "Monthly Content", description: "Regular monthly content creation and management", status: "active", priority: "medium", tasks: 8 },
            { id: 2, title: "TM Media Insights", description: "Talent marketing media insights and analysis", status: "active", priority: "high", tasks: 1 },
            { id: 3, title: "Competitor Research", description: "Research and analysis of competitor strategies", status: "active", priority: "medium", tasks: 1 },
            { id: 4, title: "MCAP", description: "Marketing Campaign Approval Process", status: "active", priority: "high", tasks: 2 },
            { id: 5, title: "Concept Planning", description: "Q4 concept planning and strategy", status: "active", priority: "medium", tasks: 1 }
        ];

        let tasks = JSON.parse(localStorage.getItem('tasks')) || [
            { id: 1, title: "Send draft email to Jen", description: "Draft email to Jen to send to Jill", status: "todo", priority: "urgent", project_id: 1, due_date: "2025-08-11", todos: [], approvals: [], attachments: [], activity: [], completed: false },
            { id: 2, title: "UHC Video - Suzanne request", description: "Handle Suzanne's video request", status: "todo", priority: "urgent", project_id: 1, due_date: "2025-08-11", todos: [], approvals: [], attachments: [], activity: [], completed: false },
            { id: 3, title: "2025 Revised Messaging Framework", description: "Updated messaging framework for 2025", status: "review", priority: "high", project_id: 4, due_date: "2025-08-12", todos: [], approvals: [], attachments: [], activity: [], completed: false },
            { id: 4, title: "LinkedIn Learning Project Management", description: "Complete LinkedIn Learning course", status: "in_progress", priority: "low", project_id: 1, todos: [], approvals: [], attachments: [], activity: [], completed: false },
            { id: 5, title: "Q4 Concept Planning", description: "Strategic planning for Q4 concepts", status: "todo", priority: "medium", project_id: 5, todos: [], approvals: [], attachments: [], activity: [], completed: false }
        ];

        let vendors = JSON.parse(localStorage.getItem('vendors')) || [
            { id: 1, name: "24 Seven", contact: "Ashley Sanchez", email: "ashley@24seven.com", phone: "(555) 123-4567", services: "Creative Services, Graphic Design, Video Production" },
            { id: 2, name: "Home Agency", contact: "Sarah Johnson", email: "sarah@homeagency.com", phone: "(555) 234-5678", services: "Digital Marketing, Social Media Management, SEO" },
            { id: 3, name: "Creative Partners", contact: "Mike Chen", email: "mike@creativepartners.com", phone: "(555) 345-6789", services: "Brand Strategy, Logo Design, Marketing Campaigns" },
            { id: 4, name: "Tech Solutions", contact: "Jennifer Davis", email: "jen@techsolutions.com", phone: "(555) 456-7890", services: "Web Development, App Development, IT Support" }
        ];

        let resources = JSON.parse(localStorage.getItem('resources')) || [
            { id: 1, name: "1-1 jen", url: "https://www.onenote.com/hrd?id=f8b7e6d5c4a3b2c1d0e9f8a7b6c5d4e3&wd=target%28Quick%20Notes.one%7C%2F%29", description: "OneNote for 1-1 status updates" },
            { id: 2, name: "Kanban board", url: "https://optum.my.workfront.com/project/view?ID=66b6b6b6b6b6b6b6b6b6b6b6", description: "Adobe Workfront Kanban board" },
            { id: 3, name: "Clinical messaging framework", url: "https://optumcare.sharepoint.com/:w:/r/sites/ClinicalMessagingFramework/_layouts/15/Doc.aspx?sourcedoc=%7B12345678-1234-1234-1234-123456789012%7D&file=Clinical%20Messaging%20Framework.docx&action=default&mobileredirect=true", description: "Optum Care clinician messaging" },
            { id: 4, name: "Ecg quick connect", url: "https://ecgquickconnect.optum.com/portal", description: "ECG Quick Connect portal" },
            { id: 5, name: "Final 2025 assets", url: "https://optumcare.sharepoint.com/:f:/r/sites/2025Assets/Shared%20Documents/Final%20Assets?csf=1&web=1&e=abc123", description: "2025 social media assets library" },
            { id: 6, name: "Copilot chat", url: "https://copilot.microsoft.com/", description: "Microsoft Copilot chat interface" },
            { id: 7, name: "Working files and assets", url: "https://optumcare.sharepoint.com/:f:/r/sites/WorkingFiles/Shared%20Documents/Assets?csf=1&web=1&e=def456", description: "Working files and final assets repository" },
            { id: 8, name: "Fun cohort", url: "https://optumcare.sharepoint.com/:f:/r/sites/FunCohort/Shared%20Documents?csf=1&web=1&e=ghi789", description: "Fun cohort project files" },
            { id: 9, name: "AEM Brand portal", url: "https://optum.scene7.com/s7viewers/html5/eCatalogViewer.html?asset=Optum/BrandPortal", description: "Adobe Experience Manager brand portal" }
        ];

        let reminders = JSON.parse(localStorage.getItem('reminders')) || [
            { id: 1, text: "Call dentist for appointment", completed: false, created: new Date().toISOString() },
            { id: 2, text: "Review Q4 budget proposal", completed: false, created: new Date().toISOString() },
            { id: 3, text: "Update LinkedIn profile", completed: true, created: new Date().toISOString() }
        ];

        // Save data to localStorage function
        function saveData() {
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('vendors', JSON.stringify(vendors));
            localStorage.setItem('resources', JSON.stringify(resources));
            localStorage.setItem('reminders', JSON.stringify(reminders));
        }

        // Mobile menu functionality
        function initializeMobileMenu() {
            document.getElementById('open-sidebar').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('mobile-menu-closed');
                document.getElementById('sidebar').classList.add('mobile-menu-open');
                document.getElementById('mobile-overlay').classList.remove('hidden');
            });

            document.getElementById('close-sidebar').addEventListener('click', closeMobileMenu);
            document.getElementById('mobile-overlay').addEventListener('click', closeMobileMenu);
        }

        function closeMobileMenu() {
            document.getElementById('sidebar').classList.remove('mobile-menu-open');
            document.getElementById('sidebar').classList.add('mobile-menu-closed');
            document.getElementById('mobile-overlay').classList.add('hidden');
        }

        // Section navigation
        function showSection(sectionName) {
            currentSection = sectionName;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-white', 'gradient-bg');
                link.classList.add('text-gray-700');
            });
            
            // Highlight active nav item
            const activeLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeLink) {
                activeLink.classList.remove('text-gray-700');
                activeLink.classList.add('text-white', 'gradient-bg');
            }
            
            // Load section-specific content
            if (sectionName === 'dashboard') {
                loadDashboard();
            } else if (sectionName === 'kanban') {
                loadKanban();
            } else if (sectionName === 'vendors') {
                loadVendors();
            } else if (sectionName === 'resources') {
                loadResources();
            }
            
            // Close mobile menu
            closeMobileMenu();
        }

        // Task detail functionality
        function showTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || task.completed) return;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show task detail section
            const taskDetailSection = document.getElementById('task-detail-section');
            taskDetailSection.classList.remove('hidden');
            
            // Get project info
            const project = projects.find(p => p.id === task.project_id);
            const projectName = project ? project.title : 'Unknown Project';
            
            // Determine back button text and action based on current section
            let backButtonText = 'Back to Dashboard';
            let backButtonAction = "showSection('dashboard')";
            
            if (currentSection === 'kanban') {
                backButtonText = 'Back to Kanban Board';
                backButtonAction = "showSection('kanban')";
            } else if (currentSection.startsWith('project-detail')) {
                backButtonText = 'Back to Project Overview';
                backButtonAction = `showProjectDetail(${task.project_id})`;
            }
            
            // Populate task detail content
            taskDetailSection.innerHTML = `
                <div class="mb-8">
                    <button onclick="${backButtonAction}" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium mb-4 flex items-center">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>
                        ${backButtonText}
                    </button>
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">${task.title}</h1>
                            <p class="text-gray-600 mt-1">${task.description}</p>
                            <p class="text-sm text-gray-500 mt-2">Project: ${projectName}</p>
                            ${task.due_date ? `<p class="text-sm text-gray-500">Due: ${formatDate(task.due_date)}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editTask(${task.id})" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                                <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                                Edit Task
                            </button>
                            <button onclick="markTaskComplete(${task.id})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                                <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                                Mark Complete
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Todo Checklist -->
                    <div class="bg-white rounded-lg shadow-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Todo Checklist</h3>
                            <button onclick="addTodoItem(${task.id})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                Add Item
                            </button>
                        </div>
                        <div id="todo-list-${task.id}" class="space-y-2">
                            ${(task.todos || []).map((todo, index) => `
                                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                    <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                                           onchange="toggleTodoItem(${task.id}, ${index})"
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="${todo.completed ? 'line-through text-gray-500' : 'text-gray-900'} flex-1">${todo.text}</span>
                                    <button onclick="deleteTodoItem(${task.id}, ${index})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Approvals -->
                    <div class="bg-white rounded-lg shadow-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Approvals</h3>
                            <button onclick="addApproval(${task.id})" class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                                <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                Add Approver
                            </button>
                        </div>
                        <div id="approval-list-${task.id}" class="space-y-2">
                            ${(task.approvals || []).map((approval, index) => `
                                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                    <input type="checkbox" ${approval.approved ? 'checked' : ''} 
                                           onchange="toggleApproval(${task.id}, ${index})"
                                           class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="flex-1 text-gray-900">${approval.name}</span>
                                    ${approval.approved ? `<span class="text-xs text-gray-500">${approval.date}</span>` : ''}
                                    <button onclick="deleteApproval(${task.id}, ${index})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- File Attachments -->
                    <div class="bg-white rounded-lg shadow-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Files & Links</h3>
                            <button onclick="addAttachment(${task.id})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                Add File/Link
                            </button>
                        </div>
                        <div id="attachment-list-${task.id}" class="space-y-2">
                            ${(task.attachments || []).map((attachment, index) => `
                                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                    <i data-lucide="paperclip" class="w-4 h-4 text-gray-500"></i>
                                    <a href="${attachment.url}" target="_blank" class="flex-1 text-blue-600 hover:text-blue-800 truncate">${attachment.name}</a>
                                    <button onclick="deleteAttachment(${task.id}, ${index})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="bg-white rounded-lg shadow-card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Activity Log</h3>
                        <div id="activity-log-${task.id}" class="space-y-2 max-h-64 overflow-y-auto">
                            ${(task.activity || []).map(activity => `
                                <div class="text-sm text-gray-600 p-2 bg-gray-50 rounded">
                                    <span class="font-medium">${activity.action}</span>
                                    <span class="text-xs text-gray-500 block">${activity.timestamp}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Task management functions
        function addTodoItem(taskId) {
            const text = prompt('Enter todo item:');
            if (text) {
                const task = tasks.find(t => t.id === taskId);
                if (!task.todos) task.todos = [];
                task.todos.push({ text: text, completed: false });
                
                // Add to activity log
                if (!task.activity) task.activity = [];
                task.activity.unshift({
                    action: `Added todo: "${text}"`,
                    timestamp: new Date().toLocaleString()
                });
                
                saveData();
                showTaskDetail(taskId);
            }
        }

        function toggleTodoItem(taskId, index) {
            const task = tasks.find(t => t.id === taskId);
            task.todos[index].completed = !task.todos[index].completed;
            
            // Add to activity log
            if (!task.activity) task.activity = [];
            task.activity.unshift({
                action: `${task.todos[index].completed ? 'Completed' : 'Uncompleted'} todo: "${task.todos[index].text}"`,
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            showTaskDetail(taskId);
        }

        function deleteTodoItem(taskId, index) {
            const task = tasks.find(t => t.id === taskId);
            const todoText = task.todos[index].text;
            task.todos.splice(index, 1);
            
            // Add to activity log
            if (!task.activity) task.activity = [];
            task.activity.unshift({
                action: `Deleted todo: "${todoText}"`,
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            showTaskDetail(taskId);
        }

        function addApproval(taskId) {
            const name = prompt('Enter approver name:');
            if (name) {
                const task = tasks.find(t => t.id === taskId);
                if (!task.approvals) task.approvals = [];
                task.approvals.push({ name: name, approved: false, date: null });
                
                // Add to activity log
                if (!task.activity) task.activity = [];
                task.activity.unshift({
                    action: `Added approver: ${name}`,
                    timestamp: new Date().toLocaleString()
                });
                
                saveData();
                showTaskDetail(taskId);
            }
        }

        function toggleApproval(taskId, index) {
            const task = tasks.find(t => t.id === taskId);
            task.approvals[index].approved = !task.approvals[index].approved;
            task.approvals[index].date = task.approvals[index].approved ? new Date().toLocaleDateString() : null;
            
            // Add to activity log
            if (!task.activity) task.activity = [];
            task.activity.unshift({
                action: `${task.approvals[index].approved ? 'Approved by' : 'Unapproved by'} ${task.approvals[index].name}`,
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            showTaskDetail(taskId);
        }

        function deleteApproval(taskId, index) {
            const task = tasks.find(t => t.id === taskId);
            const approverName = task.approvals[index].name;
            task.approvals.splice(index, 1);
            
            // Add to activity log
            if (!task.activity) task.activity = [];
            task.activity.unshift({
                action: `Removed approver: ${approverName}`,
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            showTaskDetail(taskId);
        }

        function addAttachment(taskId) {
            const name = prompt('Enter file/link name:');
            if (name) {
                const url = prompt('Enter URL:');
                if (url) {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task.attachments) task.attachments = [];
                    task.attachments.push({ name: name, url: url });
                    
                    // Add to activity log
                    if (!task.activity) task.activity = [];
                    task.activity.unshift({
                        action: `Added attachment: ${name}`,
                        timestamp: new Date().toLocaleString()
                    });
                    
                    saveData();
                    showTaskDetail(taskId);
                }
            }
        }

        function deleteAttachment(taskId, index) {
            const task = tasks.find(t => t.id === taskId);
            const attachmentName = task.attachments[index].name;
            task.attachments.splice(index, 1);
            
            // Add to activity log
            if (!task.activity) task.activity = [];
            task.activity.unshift({
                action: `Deleted attachment: ${attachmentName}`,
                timestamp: new Date().toLocaleString()
            });
            
            saveData();
            showTaskDetail(taskId);
        }

        function markTaskComplete(taskId) {
            if (confirm('Mark this task as complete? It will be removed from active views.')) {
                const task = tasks.find(t => t.id === taskId);
                task.completed = true;
                task.status = 'completed';
                
                // Add to activity log
                if (!task.activity) task.activity = [];
                task.activity.unshift({
                    action: 'Task marked as complete',
                    timestamp: new Date().toLocaleString()
                });
                
                saveData();
                showSection(currentSection);
            }
        }

        // Edit task function
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate the new task form with existing task data
            document.getElementById('new-task-title').value = task.title;
            document.getElementById('new-task-description').value = task.description;
            document.getElementById('new-task-project').value = task.project_id;
            document.getElementById('new-task-priority').value = task.priority;
            document.getElementById('new-task-due-date').value = task.due_date || '';
            
            // Change the form title and button text
            document.querySelector('#new-task-modal h3').textContent = 'Edit Task';
            document.querySelector('#new-task-modal button[type="submit"]').textContent = 'Update Task';
            
            // Store the task ID for updating
            document.getElementById('new-task-form').dataset.editingId = taskId;
            
            // Show the modal
            document.getElementById('new-task-modal').classList.remove('hidden');
        }

        // Load dashboard content
        function loadDashboard() {
            // Update current date - new format: Day of week, Month, Date
            const now = new Date();
            const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
            const month = now.toLocaleDateString('en-US', { month: 'long' });
            const date = now.getDate();
            
            document.getElementById('current-day-header').textContent = dayOfWeek;
            document.getElementById('current-month-date').textContent = `${month} ${date}`;

            // Load urgent tasks (due within 48 hours)
            const urgentTasksContainer = document.getElementById('urgent-tasks');
            const now48h = new Date();
            now48h.setHours(now48h.getHours() + 48);
            
            const urgentTasks = tasks.filter(task => {
                if (!task.due_date || task.completed) return false;
                const dueDate = new Date(task.due_date);
                return dueDate <= now48h;
            });

            urgentTasksContainer.innerHTML = urgentTasks.length > 0 ? 
                urgentTasks.map(task => `
                    <div onclick="showTaskDetail(${task.id})" class="task-card-clickable p-3 bg-red-50 border border-red-200 rounded-lg mb-2">
                        <h4 class="font-medium text-red-900">${task.title}</h4>
                        <p class="text-sm text-red-700">Due: ${formatDate(task.due_date)}</p>
                    </div>
                `).join('') : 
                '<p class="text-gray-500 text-sm">No urgent tasks</p>';

            // Load recent projects (clickable)
            const recentProjectsContainer = document.getElementById('recent-projects');
            recentProjectsContainer.innerHTML = projects.slice(0, 5).map(project => `
                <div onclick="showProjectDetail(${project.id})" class="task-card-clickable p-3 bg-blue-50 border border-blue-200 rounded-lg mb-2">
                    <h4 class="font-medium text-blue-900">${project.title}</h4>
                    <p class="text-sm text-blue-700">${project.tasks} tasks</p>
                </div>
            `).join('');

            // Load reminders
            loadReminders();
        }

        // Load kanban board
        function loadKanban() {
            const columns = {
                'todo': document.getElementById('todo-column'),
                'in_progress': document.getElementById('in-progress-column'),
                'review': document.getElementById('review-column'),
                'completed': document.getElementById('completed-column')
            };

            // Clear all columns
            Object.values(columns).forEach(column => {
                if (column) column.innerHTML = '';
            });

            // Filter out completed tasks and populate columns
            const activeTasks = tasks.filter(task => !task.completed);
            
            activeTasks.forEach(task => {
                const column = columns[task.status];
                if (column) {
                    const taskCard = createTaskCard(task);
                    column.appendChild(taskCard);
                }
            });

            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Create task card element
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card-clickable bg-white p-4 rounded-lg shadow-card border border-gray-200 hover-lift transition-all duration-200';
            card.draggable = true;
            card.dataset.taskId = task.id;
            card.onclick = () => showTaskDetail(task.id);

            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <h4 class="font-medium text-gray-900 text-sm">${task.title}</h4>
                    <div class="w-2 h-2 rounded-full ${getPriorityColor(task.priority)}"></div>
                </div>
                <p class="text-xs text-gray-600 mb-3">${task.description}</p>
                <div class="flex items-center justify-end">
                    ${task.due_date ? `<span class="text-xs text-gray-500">${formatDate(task.due_date)}</span>` : ''}
                </div>
            `;

            // Add drag and drop event listeners
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        // Drag and drop functionality
        let draggedTask = null;

        function handleDragStart(e) {
            draggedTask = e.currentTarget;
            e.currentTarget.style.opacity = '0.5';
            e.currentTarget.style.transform = 'scale(1.05)';
        }

        function handleDragEnd(e) {
            e.currentTarget.style.opacity = '';
            e.currentTarget.style.transform = '';
            draggedTask = null;
        }

        // Initialize drag and drop for columns
        function initializeDragAndDrop() {
            const columns = document.querySelectorAll('[id$="-column"]');
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '';
            
            if (draggedTask) {
                const taskId = parseInt(draggedTask.dataset.taskId);
                const newStatus = e.currentTarget.id.replace('-column', '');
                
                // Update task status
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    saveData();
                    loadKanban();
                    
                    // Flash success animation
                    e.currentTarget.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
                    setTimeout(() => {
                        e.currentTarget.style.backgroundColor = '';
                    }, 300);
                }
            }
        }

        // Load project list in sidebar
        function loadProjectList() {
            const projectListContainer = document.getElementById('project-list');
            if (projectListContainer) {
                projectListContainer.innerHTML = projects.map(project => `
                    <a href="#" onclick="showProjectDetail(${project.id})" class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100 transition-colors duration-200">
                        <span class="truncate">${project.title}</span>
                        <span class="text-xs text-gray-500">${project.tasks}</span>
                    </a>
                `).join('');
            }
        }

        // Show project detail view
        function showProjectDetail(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show or create project detail section
            let projectDetailSection = document.getElementById('project-detail-section');
            if (!projectDetailSection) {
                projectDetailSection = document.createElement('div');
                projectDetailSection.id = 'project-detail-section';
                projectDetailSection.className = 'section px-4 sm:px-6 lg:px-8';
                document.querySelector('main').appendChild(projectDetailSection);
            }
            
            // Make sure the project detail section is visible
            projectDetailSection.classList.remove('hidden');
            
            // Get project tasks (exclude completed tasks)
            const projectTasks = tasks.filter(task => task.project_id === projectId && !task.completed);
            
            // Check if this is Monthly Content project (ID 1)
            const isMonthlyContent = projectId === 1;
            
            // Populate project detail content
            projectDetailSection.innerHTML = `
                <div class="sm:flex sm:items-center sm:justify-between">
                    <div>
                        <button onclick="showSection('dashboard')" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium mb-2 flex items-center">
                            <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>
                            Back to Dashboard
                        </button>
                        <div class="flex items-center space-x-3">
                            <div>
                                <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">${project.title}</h1>
                                <p class="mt-1 text-sm text-gray-500">${project.description}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                        <button onclick="showNewTaskForm(${project.id})" class="block rounded-md bg-indigo-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                            New Task
                        </button>
                    </div>
                </div>

                ${isMonthlyContent ? `
                <div class="mt-8">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showMonthlyTab('all')" data-month="all" class="monthly-tab-btn border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                All Tasks (<span id="task-count">${projectTasks.length}</span>)
                            </button>
                            <button onclick="showMonthlyTab('august')" data-month="august" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                August
                            </button>
                            <button onclick="showMonthlyTab('september')" data-month="september" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                September
                            </button>
                            <button onclick="showMonthlyTab('october')" data-month="october" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                October
                            </button>
                            <button onclick="showMonthlyTab('november')" data-month="november" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                November
                            </button>
                            <button onclick="showMonthlyTab('december')" data-month="december" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                December
                            </button>
                            <button onclick="showMonthlyTab('january')" data-month="january" class="monthly-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                January
                            </button>
                        </nav>
                    </div>
                </div>
                ` : ''}

                <div class="mt-8">
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <ul class="divide-y divide-gray-200">
                            ${projectTasks.map(task => {
                                const taskMonth = getTaskMonth(task);
                                return `
                                    <li class="task-item" data-month="${taskMonth}">
                                        <div onclick="showTaskDetail(${task.id})" class="task-card-clickable px-4 py-4 hover:bg-gray-50 cursor-pointer">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0">
                                                        <div class="w-2 h-2 rounded-full ${getPriorityColor(task.priority)}"></div>
                                                    </div>
                                                    <div class="ml-4">
                                                        <div class="text-sm font-medium text-gray-900">${task.title}</div>
                                                        <div class="text-sm text-gray-500">${task.description}</div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    ${task.due_date ? `<span class="text-xs text-gray-500">${formatDate(task.due_date)}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            // Set current section to project detail
            currentSection = `project-detail-${projectId}`;
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Helper functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
        }

        function getPriorityColor(priority) {
            const colors = {
                'low': 'bg-green-400',
                'medium': 'bg-yellow-400',
                'high': 'bg-orange-400',
                'urgent': 'bg-red-400'
            };
            return colors[priority] || 'bg-gray-400';
        }

        function getPriorityBadgeClass(priority) {
            const classes = {
                'low': 'bg-green-100 text-green-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'high': 'bg-orange-100 text-orange-800',
                'urgent': 'bg-red-100 text-red-800'
            };
            return classes[priority] || 'bg-gray-100 text-gray-800';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'todo': 'bg-gray-100 text-gray-800',
                'in_progress': 'bg-blue-100 text-blue-800',
                'review': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getTaskMonth(task) {
            if (!task.due_date) return 'other';
            const date = new Date(task.due_date);
            const month = date.toLocaleDateString('en-US', { month: 'long' }).toLowerCase();
            return month;
        }

        function showMonthlyTab(month) {
            // Update tab styles
            document.querySelectorAll('.monthly-tab-btn').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeTab = document.querySelector(`[data-month="${month}"]`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-gray-500');
                activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            }
            
            // Show/hide tasks based on month
            document.querySelectorAll('.task-item').forEach(item => {
                const taskMonth = item.dataset.month;
                if (month === 'all' || taskMonth === month) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Search functionality
        function performSearch(searchTerm) {
            if (!searchTerm) {
                showSection('dashboard');
                return;
            }
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show search results section
            const searchResultsSection = document.getElementById('search-results-section');
            searchResultsSection.classList.remove('hidden');
            
            // Search through projects and tasks
            const projectResults = projects.filter(project => 
                project.title.toLowerCase().includes(searchTerm) || 
                project.description.toLowerCase().includes(searchTerm)
            );
            
            const taskResults = tasks.filter(task => 
                !task.completed && (
                    task.title.toLowerCase().includes(searchTerm) || 
                    task.description.toLowerCase().includes(searchTerm)
                )
            );
            
            // Display results
            const searchResultsContent = document.getElementById('search-results-content');
            searchResultsContent.innerHTML = `
                <div class="space-y-8">
                    ${projectResults.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projects (${projectResults.length})</h2>
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                ${projectResults.map(project => `
                                    <div onclick="showProjectDetail(${project.id})" class="task-card-clickable bg-white p-4 rounded-lg shadow-card border border-gray-200 hover-lift">
                                        <h3 class="font-medium text-gray-900">${project.title}</h3>
                                        <p class="text-sm text-gray-600 mt-1">${project.description}</p>
                                        <p class="text-xs text-gray-500 mt-2">${project.tasks} tasks</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${taskResults.length > 0 ? `
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Tasks (${taskResults.length})</h2>
                            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                                <ul class="divide-y divide-gray-200">
                                    ${taskResults.map(task => {
                                        const project = projects.find(p => p.id === task.project_id);
                                        return `
                                            <li>
                                                <div onclick="showTaskDetail(${task.id})" class="task-card-clickable px-4 py-4 hover:bg-gray-50 cursor-pointer">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center">
                                                            <div class="flex-shrink-0">
                                                                <div class="w-2 h-2 rounded-full ${getPriorityColor(task.priority)}"></div>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-gray-900">${task.title}</div>
                                                                <div class="text-sm text-gray-500">${task.description}</div>
                                                                <div class="text-xs text-gray-400">Project: ${project ? project.title : 'Unknown'}</div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getPriorityBadgeClass(task.priority)}">
                                                                ${task.priority.toUpperCase()}
                                                            </span>
                                                            ${task.due_date ? `<span class="text-xs text-gray-500">${formatDate(task.due_date)}</span>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                        `;
                                    }).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${projectResults.length === 0 && taskResults.length === 0 ? `
                        <div class="text-center py-12">
                            <i data-lucide="search" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No results found</h3>
                            <p class="text-gray-600">Try searching with different keywords.</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Load vendors
        function loadVendors() {
            const vendorsList = document.getElementById('vendors-list');
            vendorsList.innerHTML = vendors.map(vendor => `
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center">
                                        <i data-lucide="building" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-lg font-medium text-gray-900">${vendor.name}</h3>
                                    <p class="text-sm text-gray-600">${vendor.contact}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="editVendor(${vendor.id})" class="text-indigo-600 hover:text-indigo-500 p-1">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteVendor(${vendor.id})" class="text-red-600 hover:text-red-500 p-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">${vendor.services}</p>
                            <div class="mt-2 space-y-1">
                                <p class="text-xs text-gray-500">üìß ${vendor.email}</p>
                                <p class="text-xs text-gray-500">üìû ${vendor.phone}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Load resources
        function loadResources() {
            const resourcesList = document.getElementById('resources-list');
            resourcesList.innerHTML = resources.map(resource => `
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="link" class="w-4 h-4 text-white"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-lg font-medium text-gray-900">${resource.name}</h3>
                                <p class="text-sm text-gray-600">${resource.description}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="${resource.url}" target="_blank" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-orange-700 bg-orange-100 hover:bg-orange-200 transition-colors duration-200">
                                <i data-lucide="external-link" class="w-4 h-4 mr-1"></i>
                                Open Resource
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // AI Assistant functions
        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                openaiApiKey = apiKey;
                localStorage.setItem('openai-api-key', apiKey);
                document.getElementById('api-key-setup').style.display = 'none';
                alert('API key saved successfully!');
            }
        }

        function resetApiKey() {
            openaiApiKey = '';
            localStorage.removeItem('openai-api-key');
            document.getElementById('api-key-setup').style.display = 'block';
            document.getElementById('api-key-input').value = '';
            document.getElementById('chat-messages').innerHTML = '';
        }

        function clearAIChat() {
            document.getElementById('chat-messages').innerHTML = '';
        }

        function addAIMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                    sender === 'user' 
                        ? 'bg-indigo-600 text-white' 
                        : 'bg-gray-100 text-gray-900'
                }">
                    <p class="text-sm">${message}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendAIMessage() {
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const message = input.value.trim();
            
            if (!message || !openaiApiKey) return;
            
            // Add user message
            addAIMessage(message, 'user');
            input.value = '';
            
            // Show loading state
            sendButton.disabled = true;
            sendButton.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>';
            lucide.createIcons();
            
            try {
                // Prepare context data
                const contextData = {
                    projects: projects,
                    tasks: tasks.filter(task => !task.completed),
                    vendors: vendors,
                    resources: resources
                };
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a helpful AI assistant for a project management system. You have access to the user's current project data. 
                                
                                Current data:
                                Projects: ${JSON.stringify(contextData.projects, null, 2)}
                                Tasks: ${JSON.stringify(contextData.tasks, null, 2)}
                                Vendors: ${JSON.stringify(contextData.vendors, null, 2)}
                                Resources: ${JSON.stringify(contextData.resources, null, 2)}
                                
                                Please provide helpful, specific answers based on this data. Be conversational and friendly. When referencing specific items, use their actual names and details from the data.`
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API request failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                addAIMessage(aiResponse, 'assistant');
                
            } catch (error) {
                console.error('AI request error:', error);
                let errorMessage = 'Sorry, I encountered an error processing your request.';
                
                if (error.message.includes('401')) {
                    errorMessage = 'Invalid API key. Please check your OpenAI API key and try again.';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Access denied. Please check your API key permissions.';
                }
                
                addAIMessage(errorMessage, 'assistant');
            }
            
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i>';
            lucide.createIcons();
        }

        // Form handling functions
        function showNewProjectForm() {
            document.getElementById('new-project-modal').classList.remove('hidden');
        }

        function hideNewProjectForm() {
            document.getElementById('new-project-modal').classList.add('hidden');
            document.getElementById('new-project-form').reset();
        }

        function showNewTaskForm(projectId = null) {
            const modal = document.getElementById('new-task-modal');
            const projectSelect = document.getElementById('new-task-project');
            
            // Reset form state for new task
            document.querySelector('#new-task-modal h3').textContent = 'Add New Task';
            document.querySelector('#new-task-modal button[type="submit"]').textContent = 'Add Task';
            delete document.getElementById('new-task-form').dataset.editingId;
            
            // Populate project dropdown
            projectSelect.innerHTML = projects.map(project => 
                `<option value="${project.id}" ${projectId === project.id ? 'selected' : ''}>${project.title}</option>`
            ).join('');
            
            modal.classList.remove('hidden');
        }

        function hideNewTaskForm() {
            document.getElementById('new-task-modal').classList.add('hidden');
            document.getElementById('new-task-form').reset();
        }

        function showNewResourceForm() {
            document.getElementById('new-resource-modal').classList.remove('hidden');
        }

        function hideNewResourceForm() {
            document.getElementById('new-resource-modal').classList.add('hidden');
            document.getElementById('new-resource-form').reset();
        }

        function showNewVendorForm() {
            // Reset form state for new vendor
            document.querySelector('#new-vendor-modal h3').textContent = 'Add New Vendor';
            document.querySelector('#new-vendor-modal button[type="submit"]').textContent = 'Add Vendor';
            delete document.getElementById('new-vendor-form').dataset.editingId;
            
            document.getElementById('new-vendor-modal').classList.remove('hidden');
        }

        function hideNewVendorForm() {
            document.getElementById('new-vendor-modal').classList.add('hidden');
            document.getElementById('new-vendor-form').reset();
        }

        // Edit vendor function
        function editVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            // Populate the form with existing vendor data
            document.getElementById('new-vendor-name').value = vendor.name;
            document.getElementById('new-vendor-contact').value = vendor.contact;
            document.getElementById('new-vendor-email').value = vendor.email;
            document.getElementById('new-vendor-phone').value = vendor.phone;
            document.getElementById('new-vendor-services').value = vendor.services;
            
            // Change the form title and button text
            document.querySelector('#new-vendor-modal h3').textContent = 'Edit Vendor';
            document.querySelector('#new-vendor-modal button[type="submit"]').textContent = 'Update Vendor';
            
            // Store the vendor ID for updating
            document.getElementById('new-vendor-form').dataset.editingId = vendorId;
            
            // Show the modal
            document.getElementById('new-vendor-modal').classList.remove('hidden');
        }

        // Delete vendor function
        function deleteVendor(vendorId) {
            const vendor = vendors.find(v => v.id === vendorId);
            if (!vendor) return;
            
            if (confirm(`Are you sure you want to delete "${vendor.name}"? This action cannot be undone.`)) {
                vendors = vendors.filter(v => v.id !== vendorId);
                saveData();
                loadVendors();
                alert('Vendor deleted successfully!');
            }
        }

        // Reminders functions
        function loadReminders() {
            const remindersList = document.getElementById('reminders-list');
            if (!remindersList) return;
            
            remindersList.innerHTML = reminders.map(reminder => `
                <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded group hover:bg-gray-100 transition-colors duration-200">
                    <input type="checkbox" ${reminder.completed ? 'checked' : ''} 
                           onchange="toggleReminder(${reminder.id})"
                           class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                    <span class="${reminder.completed ? 'line-through text-gray-500' : 'text-gray-900'} flex-1 text-sm cursor-pointer" 
                          onclick="editReminder(${reminder.id})">${reminder.text}</span>
                    <button onclick="deleteReminder(${reminder.id})" class="text-red-600 hover:text-red-800 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        function addReminder() {
            const text = prompt('Enter reminder:');
            if (text && text.trim()) {
                const newReminder = {
                    id: Math.max(...reminders.map(r => r.id), 0) + 1,
                    text: text.trim(),
                    completed: false,
                    created: new Date().toISOString()
                };
                
                reminders.unshift(newReminder);
                saveData();
                loadReminders();
            }
        }

        function editReminder(reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            const newText = prompt('Edit reminder:', reminder.text);
            if (newText && newText.trim() && newText.trim() !== reminder.text) {
                reminder.text = newText.trim();
                saveData();
                loadReminders();
            }
        }

        function toggleReminder(reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (reminder) {
                reminder.completed = !reminder.completed;
                saveData();
                loadReminders();
            }
        }

        function deleteReminder(reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            if (confirm(`Delete reminder: "${reminder.text}"?`)) {
                reminders = reminders.filter(r => r.id !== reminderId);
                saveData();
                loadReminders();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load API key from localStorage
            const savedApiKey = localStorage.getItem('openai-api-key');
            if (savedApiKey) {
                openaiApiKey = savedApiKey;
                document.getElementById('api-key-setup').style.display = 'none';
            }

            // Initialize mobile menu
            initializeMobileMenu();
            
            // Initialize drag and drop
            initializeDragAndDrop();
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Load initial content
            loadProjectList();
            loadDashboard();
            
            // Initialize search functionality
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    performSearch(searchTerm);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        performSearch(searchTerm);
                    }
                });
            }
            
            // Form event listeners
            document.getElementById('new-project-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('new-project-title').value;
                const description = document.getElementById('new-project-description').value;
                
                const newProject = {
                    id: Math.max(...projects.map(p => p.id)) + 1,
                    title: title,
                    description: description,
                    status: 'active',
                    priority: 'medium',
                    tasks: 0
                };
                
                projects.push(newProject);
                saveData();
                
                loadProjectList();
                loadDashboard();
                hideNewProjectForm();
                
                alert('Project created successfully!');
            });

            document.getElementById('new-task-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('new-task-title').value;
                const description = document.getElementById('new-task-description').value;
                const projectId = parseInt(document.getElementById('new-task-project').value);
                const priority = document.getElementById('new-task-priority').value;
                const dueDate = document.getElementById('new-task-due-date').value;
                
                const editingId = this.dataset.editingId;
                
                if (editingId) {
                    // Update existing task
                    const task = tasks.find(t => t.id === parseInt(editingId));
                    if (task) {
                        const oldTitle = task.title;
                        const oldDescription = task.description;
                        const oldDueDate = task.due_date;
                        
                        task.title = title;
                        task.description = description;
                        task.project_id = projectId;
                        task.priority = priority;
                        task.due_date = dueDate || null;
                        
                        // Add to activity log
                        if (!task.activity) task.activity = [];
                        const changes = [];
                        if (oldTitle !== title) changes.push(`title changed from "${oldTitle}" to "${title}"`);
                        if (oldDescription !== description) changes.push(`description updated`);
                        if (oldDueDate !== (dueDate || null)) changes.push(`due date changed`);
                        
                        if (changes.length > 0) {
                            task.activity.unshift({
                                action: `Task updated: ${changes.join(', ')}`,
                                timestamp: new Date().toLocaleString()
                            });
                        }
                        
                        saveData();
                        
                        // Update project task count if project changed
                        const oldProject = projects.find(p => p.id === task.project_id);
                        const newProject = projects.find(p => p.id === projectId);
                        if (oldProject && newProject && oldProject.id !== newProject.id) {
                            oldProject.tasks -= 1;
                            newProject.tasks += 1;
                        }
                        
                        loadProjectList();
                        loadDashboard();
                        loadKanban();
                        
                        // Reset form state
                        delete this.dataset.editingId;
                        document.querySelector('#new-task-modal h3').textContent = 'Add New Task';
                        document.querySelector('#new-task-modal button[type="submit"]').textContent = 'Add Task';
                        
                        hideNewTaskForm();
                        showTaskDetail(parseInt(editingId)); // Return to task detail view
                        
                        alert('Task updated successfully!');
                    }
                } else {
                    // Create new task
                    const newTask = {
                        id: Math.max(...tasks.map(t => t.id)) + 1,
                        title: title,
                        description: description,
                        status: 'todo',
                        priority: priority,
                        project_id: projectId,
                        due_date: dueDate || null,
                        todos: [],
                        approvals: [],
                        attachments: [],
                        activity: [],
                        completed: false
                    };
                    
                    tasks.push(newTask);
                    saveData();
                    
                    // Update project task count
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        project.tasks += 1;
                    }
                    
                    loadProjectList();
                    loadDashboard();
                    loadKanban();
                    hideNewTaskForm();
                    
                    alert('Task created successfully!');
                }
            });

            document.getElementById('new-resource-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('new-resource-name').value;
                const url = document.getElementById('new-resource-url').value;
                const description = document.getElementById('new-resource-description').value;
                
                const newResource = {
                    id: Math.max(...resources.map(r => r.id)) + 1,
                    name: name,
                    url: url,
                    description: description
                };
                
                resources.push(newResource);
                saveData();
                
                loadResources();
                hideNewResourceForm();
                
                alert('Resource added successfully!');
            });

            document.getElementById('new-vendor-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('new-vendor-name').value;
                const contact = document.getElementById('new-vendor-contact').value;
                const email = document.getElementById('new-vendor-email').value;
                const phone = document.getElementById('new-vendor-phone').value;
                const services = document.getElementById('new-vendor-services').value;
                
                const editingId = this.dataset.editingId;
                
                if (editingId) {
                    // Update existing vendor
                    const vendor = vendors.find(v => v.id === parseInt(editingId));
                    if (vendor) {
                        vendor.name = name;
                        vendor.contact = contact;
                        vendor.email = email;
                        vendor.phone = phone;
                        vendor.services = services;
                        
                        saveData();
                        loadVendors();
                        
                        // Reset form state
                        delete this.dataset.editingId;
                        document.querySelector('#new-vendor-modal h3').textContent = 'Add New Vendor';
                        document.querySelector('#new-vendor-modal button[type="submit"]').textContent = 'Add Vendor';
                        
                        hideNewVendorForm();
                        alert('Vendor updated successfully!');
                    }
                } else {
                    // Create new vendor
                    const newVendor = {
                        id: Math.max(...vendors.map(v => v.id)) + 1,
                        name: name,
                        contact: contact,
                        email: email,
                        phone: phone,
                        services: services
                    };
                    
                    vendors.push(newVendor);
                    saveData();
                    
                    loadVendors();
                    hideNewVendorForm();
                    
                    alert('Vendor added successfully!');
                }
            });
        });
    </script>
</body>
</html>
